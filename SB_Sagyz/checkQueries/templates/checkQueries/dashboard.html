{% extends "authApp/base.html" %}

{% load static %}

{% block content %}
<div class="container mt-5" ng-app="dashboardApp" ng-controller="DashboardController">
    <h2 class="text-center">Ваш личный кабинет</h2>
    <div class="card mt-3">
        <div class="card-body">
            <h5 class="card-title text-center">Личные данные</h5>
            <p class="card-text"><strong>Имя пользователя:</strong> {{ user.username }} </p>
            <p class="card-text"><strong>Email:</strong> {{ user.email }}</p>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-body">
            <h5 class="card-title text-center">История запросов</h5>
            <input type="text" class="form-control mb-3" placeholder="Поиск по имени" id="searchQuery" onkeyup="filterTable()">
            <table class="table table-striped" id="scanHistoryTable">
                <thead>
                    <tr>
                        <th ng-click="sortData('query.ip_or_domain')">IP или домен <span class="sort-icon" ng-show="sortColumn=='query.ip_or_domain'" ng-class="{'fa fa-caret-down':reverseSort,'fa fa-caret-up':!reverseSort}"></span></th>
                        <th ng-click="sortData('search_date')">Дата <span class="sort-icon" ng-show="sortColumn=='search_date'" ng-class="{'fa fa-caret-down':reverseSort,'fa fa-caret-up':!reverseSort}"></span></th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody>
                    {% for history in scan_history %}
                        <tr onclick="window.location.href='{% url 'query_info' history.query.id %}'">
                            <td>{{ history.query.ip_or_domain }}</td>
                            <td>{{ history.search_date|date:"d.m.Y" }}</td>
                            <td>{{ history.query.get_status_display }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    var app = angular.module('dashboardApp', []);
    app.controller('DashboardController', function($scope) {
        $scope.sortColumn = 'query.ip_or_domain';
        $scope.reverseSort = false;

        $scope.sortData = function(column) {
            $scope.reverseSort = ($scope.sortColumn == column) ? !$scope.reverseSort : false;
            $scope.sortColumn = column;
        }
    });

    function filterTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("searchQuery");
        filter = input.value.toUpperCase();
        table = document.getElementById("scanHistoryTable");
        tr = table.getElementsByTagName("tr");

        for (i = 1; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[0];
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
{% endblock %}